<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finpi â€” Testnet</title>
  <link rel="icon" href="/logo.png" />
  <style>
    body { font-family: system-ui, sans-serif; text-align:center; padding:40px; background:#f6f7fb; }
    .btn { padding:14px 20px; border-radius:12px; border:0; cursor:pointer; font-size:16px; }
    .login { background:#6e4cff; color:#fff; margin-bottom:12px; }
    .pay { background:#ff8a00; color:#fff; }
    .info { margin-top:18px; color:#666; white-space:pre-line; }
  </style>
</head>

<body>
  <img src="/logo.png" width="100" alt="Finpi logo" />
  <h1>Welcome to Finpi</h1>
  <p>Testnet Mode â€” Login and Pay (open in Pi Browser)</p>

  <button id="loginBtn" class="btn login">ğŸ” Login with Pi (Testnet)</button>
  <button id="payBtn" class="btn pay">ğŸ’¸ Pay with Pi (Testnet)</button>

  <div id="status" class="info"></div>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    Pi.init({
      version: "2.0",
      sandbox: true
    });
  </script>

  <script>
    const statusEl = document.getElementById('status');
    function info(msg) { statusEl.textContent = msg; console.log(msg); }

    // LOGIN
    document.getElementById('loginBtn').addEventListener('click', async () => {
      if (!window.Pi) return alert("Open this page in Pi Browser.");

      info("Opening Pi Testnet authentication...");

      try {
        const auth = await Pi.authenticate(['username', 'payments']);
        info("Logged in as: " + auth.user.username);

        await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: auth.user })
        });

      } catch (err) {
        info("Login failed: " + err.message);
      }
    });

    // PAY
    document.getElementById('payBtn').addEventListener('click', async () => {
      if (!window.Pi) return alert("Open in Pi Browser.");

      info("Creating payment...");

      try {
        const createResp = await fetch('/api/payments_create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: 0.01,
            memo: "Finpi Test Payment",
            metadata: { app: "Finpi" }
          })
        });

        const paymentData = await createResp.json();

        await Pi.createPayment(paymentData, {
          onReadyForServerApproval: async (paymentId) => {
            info("Payment pending approval: " + paymentId);

            await fetch('/api/payments_approve', {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId })
            });
          },

          onReadyForServerCompletion: async (paymentId, txid) => {
            info("Payment completed:\nTxID: " + txid);

            await fetch('/api/payments_complete', {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid })
            });
          },

          onCancel: () => info("Payment cancelled."),
          onError: (error) => info("Payment error: " + error.message)
        });

      } catch (err) {
        info("Payment failed: " + err.message);
      }
    });
  </script>

</body>
</html>
