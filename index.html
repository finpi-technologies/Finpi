<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finpi â€” Testnet</title>
  <link rel="icon" href="/logo.png" />
  <style>
    body { font-family: system-ui, sans-serif; text-align:center; padding:40px; background:#f6f7fb; }
    .btn { padding:14px 20px; border-radius:12px; border:0; cursor:pointer; font-size:16px; }
    .login { background:#6e4cff; color:#fff; margin-bottom:12px; }
    .pay { background:#ff8a00; color:#fff; }
    .info { margin-top:18px; color:#666; }
  </style>
</head>
<body>
  <img src="/logo.png" width="100" alt="Finpi logo" />
  <h1>Welcome to Finpi</h1>
  <p>Testnet Mode â€” Login and Pay (open in Pi Browser)</p>

  <button id="loginBtn" class="btn login">ğŸ” Login with Pi (Testnet)</button>
  <button id="payBtn" class="btn pay">ğŸ’¸ Pay with Pi (Testnet)</button>

  <div id="status" class="info"></div>

  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    const statusEl = document.getElementById('status');

    // Helper to show messages
    function info(msg) { statusEl.textContent = msg; console.log(msg); }

    // login handler
    document.getElementById('loginBtn').addEventListener('click', async () => {
      if (!window.Pi) return alert('Open this page in Pi Browser.');
      info('Opening Pi Testnet authentication...');
      try {
        const auth = await Pi.authenticate(['username','payments']);
        // auth.user contains user info returned by Pi Browser
        info('Logged in: ' + (auth?.user?.username || auth?.user?.id || 'unknown'));
        // send to your backend login
        await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: auth.user })
        });
      } catch (err) {
        console.error(err);
        info('Login failed: ' + (err.message || err));
      }
    });

    // pay handler
    document.getElementById('payBtn').addEventListener('click', async () => {
      if (!window.Pi) return alert('Open this page in Pi Browser.');
      info('Creating payment request...');
      try {
        // Ask backend for payment object (or create local payment)
        const createResp = await fetch('/api/payments_create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: 0.01, memo: 'Finpi Test Payment', metadata: { app: 'Finpi' } })
        });
        const paymentObj = await createResp.json();

        // Start payment in Pi Browser
        await Pi.createPayment(paymentObj, {
          onReadyForServerApproval: async (paymentId) => {
            info('Ready for server approval: ' + paymentId);
            // notify your backend so it can record the pending payment
            await fetch('/api/payments_create', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ amount: paymentObj.amount, memo: paymentObj.memo, metadata: paymentObj.metadata, paymentId })
            });
          },
          onReadyForServerCompletion: async (paymentId, txid) => {
            info('Payment completed: ' + txid);
            // notify backend of completion
            await fetch('/api/payments_complete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ paymentId, txid })
            });
          },
          onCancel: (paymentId) => { info('Payment cancelled'); },
          onError: (err) => { info('Payment error: ' + (err?.message || err)); }
        });
      } catch (err) {
        console.error(err);
        info('Payment start failed: ' + (err?.message || err));
      }
    });
  </script>
</body>
</html>
