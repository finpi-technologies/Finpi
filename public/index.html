<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finpi ‚Äî Testnet</title>

  <!-- SEO -->
  <meta name="description" content="Finpi ‚Äî secure fintech testnet payments powered by Pi Network" />

  <!-- Favicon -->
  <link rel="icon" href="/logo.png" />

  <style>
    :root {
      --purple: #6e4cff;
      --orange: #ff8a00;
      --bg: #f6f7fb;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 92%;
      max-width: 460px;
      background: #ffffff;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
      text-align: center;
    }

    .logo {
      width: 86px;
      border-radius: 14px;
      margin-bottom: 14px;
    }

    h1 {
      margin: 6px 0;
    }

    .lead {
      color: #444;
      margin: 0 0 18px;
    }

    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 12px;
      border: none;
      color: #ffffff;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
    }

    .login {
      background: linear-gradient(90deg, var(--purple), #4b3aff);
    }

    .pay {
      background: linear-gradient(90deg, var(--orange), #e86b00);
    }

    .status {
      margin-top: 14px;
      padding: 12px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.05);
      min-height: 48px;
      font-size: 14px;
      white-space: pre-line;
    }

    footer {
      margin-top: 14px;
      font-size: 12px;
      color: #888;
    }
  </style>
</head>

<body>
  <div class="card">
    <img src="/logo.png" alt="Finpi Logo" class="logo" />

    <h1>Finpi</h1>
    <p class="lead">
      Secure Testnet payments ‚Äî open in Pi Browser
    </p>

    <button id="loginBtn" class="btn login">
      üîê Login with Pi (Testnet)
    </button>

    <button id="payBtn" class="btn pay">
      üí∏ Pay 0.01 œÄ (Testnet)
    </button>

    <div id="status" class="status">
      Ready ‚Äî open this page inside Pi Browser.
    </div>

    <footer>¬© 2025 Finpi Technologies</footer>
  </div>

  <!-- Pi SDK (do not modify) -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <script>
    const statusEl = document.getElementById("status");

    function info(message) {
      statusEl.textContent = message;
      console.log(message);
    }

    // Initialize Pi SDK (Testnet / Sandbox)
    if (window.Pi) {
      Pi.init({ version: "2.0", sandbox: true });
      info("Pi SDK detected. Ready for Testnet.");
    } else {
      info("Pi SDK not detected ‚Äî open in Pi Browser.");
    }

    // LOGIN
    document.getElementById("loginBtn").addEventListener("click", async () => {
      if (!window.Pi) {
        alert("Please open this page inside Pi Browser.");
        return;
      }

      info("Opening Pi authentication...");

      try {
        const auth = await Pi.authenticate(["username", "payments"]);
        info("Logged in as: " + (auth.user?.username || "Unknown user"));

        // Optional backend call
        await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user: auth.user })
        });

      } catch (err) {
        info("Login failed: " + (err.message || err));
      }
    });

    // PAYMENT
    document.getElementById("payBtn").addEventListener("click", async () => {
      if (!window.Pi) {
        alert("Please open this page inside Pi Browser.");
        return;
      }

      info("Creating payment request...");

      try {
        const response = await fetch("/api/payments_create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: 0.01,
            memo: "Finpi Testnet Payment",
            metadata: { app: "Finpi" }
          })
        });

        const paymentData = await response.json();

        await Pi.createPayment(paymentData, {
          onReadyForServerApproval: async (paymentId) => {
            info("Awaiting server approval...");
            await fetch("/api/payments_approve", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId })
            });
          },

          onReadyForServerCompletion: async (paymentId, txid) => {
            info("Payment completed.\nTxID: " + txid);
            await fetch("/api/payments_complete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid })
            });
          },

          onCancel: () => info("Payment cancelled by user."),
          onError: (e) => info("Payment error: " + (e?.message || e))
        });

      } catch (e) {
        info("Payment failed: " + (e.message || e));
      }
    });
  </script>
</body>
  </html>
