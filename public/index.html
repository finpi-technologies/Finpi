<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finpi ‚Äî Secure Testnet Payments</title>
  <link rel="icon" href="/favicon.ico" />
  <meta name="description" content="Finpi ‚Äî secure fintech powered by Pi Network" />
  <style>
    :root{--purple:#6e4cff;--orange:#ff8a00;--bg:#f6f7fb}
    body{font-family:system-ui,Segoe UI,Roboto,sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg)}
    .card{width:92%;max-width:480px;background:#fff;border-radius:18px;padding:28px;box-shadow:0 12px 30px rgba(10,10,20,0.07);text-align:center}
    img.logo{width:86px;border-radius:12px;margin-bottom:12px}
    h1{margin:6px 0 4px;font-size:22px}
    p.lead{margin:0 0 18px;color:#555}
    .btn{display:block;width:100%;padding:12px 14px;border-radius:12px;border:0;color:#fff;font-weight:600;font-size:15px;cursor:pointer;margin-bottom:12px}
    .login{background:linear-gradient(90deg,var(--purple),#4b3aff)}
    .pay{background:linear-gradient(90deg,var(--orange),#e86b00)}
    .status{margin-top:10px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.04);min-height:48px;white-space:pre-line}
    footer{margin-top:12px;font-size:12px;color:#888}
    @media (prefers-color-scheme:dark){body{background:#07070b}.card{background:#0f0f14;color:#eef}.status{background:rgba(255,255,255,0.04)}}
  </style>
</head>
<body>
  <div class="card">
    <img src="/logo.png" class="logo" alt="Finpi logo" />
    <h1>Finpi</h1>
    <p class="lead">Secure Testnet payments ‚Äî open in Pi Browser for full functionality.</p>

    <button id="loginBtn" class="btn login">üîê Login with Pi</button>
    <button id="payBtn" class="btn pay">üí∏ Pay 0.01 œÄ (Testnet)</button>

    <div id="status" class="status">Ready ‚Äî please open in Pi Browser and press Login.</div>
    <footer>¬© 2025 Finpi Technologies</footer>
  </div>

  <!-- Pi SDK (client) -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <script>
    // Initialize Pi SDK for sandbox (testnet) when available
    if (typeof window !== "undefined" && window.Pi) {
      Pi.init({ version: "2.0", sandbox: true });
    }

    const statusEl = document.getElementById("status");
    function info(msg){ statusEl.textContent = msg; console.log(msg); }

    // Login: uses Pi.authenticate and points auth to our backend via authUrl
    document.getElementById("loginBtn").addEventListener("click", async () => {
      if (!window.Pi) return alert("Open this page inside Pi Browser to authenticate.");
      info("Opening Pi authentication...");
      try {
        // authUrl tells Pi Browser to POST auth result to our backend
        const auth = await Pi.authenticate(
          ["username", "payments"],
          { authUrl: `${location.origin}/api/auth` } // IMPORTANT
        );
        info("Logged in as: " + (auth.user?.username || auth.user?.id || "unknown"));
      } catch (err) {
        info("Login failed: " + (err?.message || err));
      }
    });

    // Payment: ask backend for payment object and call Pi.createPayment
    document.getElementById("payBtn").addEventListener("click", async () => {
      if (!window.Pi) return alert("Open this page inside Pi Browser to pay.");
      info("Creating payment request...");
      try {
        const resp = await fetch("/api/payments_create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: 0.01,
            memo: "Finpi Test Payment",
            metadata: { app: "finpi" }
          })
        });
        const paymentData = await resp.json();
        // Start payment in Pi Browser; callbacks handled by SDK
        await Pi.createPayment(paymentData, {
          onReadyForServerApproval: async (paymentId) => {
            info("Ready for server approval: " + paymentId);
            // notify backend (server-side approval step)
            await fetch("/api/payments_approve", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId })
            });
          },
          onReadyForServerCompletion: async (paymentId, txid) => {
            info("Payment completed ‚Äî txid: " + txid);
            await fetch("/api/payments_complete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid })
            });
          },
          onCancel: () => info("Payment cancelled"),
          onError: (err) => info("Payment error: " + (err?.message || err))
        });
      } catch (err) {
        info("Payment failed: " + (err?.message || err));
      }
    });
  </script>
</body>
</html>
